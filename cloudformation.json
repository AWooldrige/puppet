{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS Infrastructure for Public Facing Sites",
    "Parameters" : {
        "AMI" : {
            "Type" : "String",
            "Description" : "The AMI (e.g. ami-f4bb5583) to launch with"
        }
    },
    "Resources": {
        "wooliecoukDNS": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": "woolie.co.uk.",
                "RecordSets": [
                    {
                        "Name": "woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "origin.woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.origin.woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "static.woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "static.origin.woolie.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "home.woolie.co.uk.",
                        "Type": "CNAME",
                        "TTL": "3600",
                        "ResourceRecords": [ "home.wooldrige.co.uk" ]
                    },
                    {
                        "Name": "woolie.co.uk.",
                        "Type": "MX",
                        "TTL": "86400",
                        "ResourceRecords": [
                            "10 ASPMX.L.GOOGLE.COM.",
                            "20 ALT1.ASPMX.L.GOOGLE.COM.",
                            "20 ALT2.ASPMX.L.GOOGLE.COM.",
                            "30 ASPMX2.GOOGLEMAIL.COM.",
                            "30 ASPMX3.GOOGLEMAIL.COM.",
                            "30 ASPMX4.GOOGLEMAIL.COM.",
                            "30 ASPMX5.GOOGLEMAIL.COM."
                        ]
                    },
                    {
                        "Name": "google._domainkey.woolie.co.uk.",
                        "Type": "TXT",
                        "TTL": "86400",
                        "ResourceRecords": [ "\"v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCD9iFbc2P35/Uay6FSHGs7hFM0je8NnpjyrAnpJDMnRKFA+5ISUrv9C3IwAQliRUMlzWkwMmFE773i7E3g3/mcyuRZCBTOLJ0WBtSZoqEWyCFG/y8RXIi+Tf0d/qBDzBE+zB8Rjl3XggEwSk7AsKz8YrodzpMI38l0EWlyOFd0tQIDAQAB\"" ]
                    },
                    {
                        "Name": "mail.woolie.co.uk.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    },
                    {
                        "Name": "docs.woolie.co.uk.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    },
                    {
                        "Name": "calendar.woolie.co.uk.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    }
                ]
            }
        },
        "onmyplatecoukDNS": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": "onmyplate.co.uk.",
                "RecordSets": [
                    {
                        "Name": "onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "origin.onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.origin.onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "static.onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "static.origin.onmyplate.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "onmyplate.co.uk.",
                        "Type": "MX",
                        "TTL": "86400",
                        "ResourceRecords": [
                            "10 ASPMX.L.GOOGLE.COM.",
                            "20 ALT1.ASPMX.L.GOOGLE.COM.",
                            "20 ALT2.ASPMX.L.GOOGLE.COM.",
                            "30 ASPMX2.GOOGLEMAIL.COM.",
                            "30 ASPMX3.GOOGLEMAIL.COM.",
                            "30 ASPMX4.GOOGLEMAIL.COM.",
                            "30 ASPMX5.GOOGLEMAIL.COM."
                        ]
                    },
                    {
                        "Name": "google._domainkey.onmyplate.co.uk.",
                        "Type": "TXT",
                        "TTL": "86400",
                        "ResourceRecords": [ "\"v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDMacew9nMsqyDqfiHyyViASAbAvPix7l+SCMrRnSSDrG6WRMT54btieUmK9tzOi39U8LMi/l29IwJOy908KY+ydkNK2n7AP0I1AJExsdzU/g92L+WMAPEI0UOep+v6i+Plv1zjFLejo0OKy5JHdk3A9PQaOLyOjpxKAN/mNhcMnQIDAQAB\"" ]
                    },
                    {
                        "Name": "CI4ZOCDZDOYT.onmyplate.co.uk.",
                        "Type": "CNAME",
                        "TTL": "1209600",
                        "ResourceRecords": [ "gv-SBHCIDQ6WSTITK.dv.googlehosted.com." ]
                    }
                ]
            }
        },
        "wooldrigecoukDNS": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": "wooldrige.co.uk.",
                "RecordSets": [
                    {
                        "Name": "wooldrige.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "home.wooldrige.co.uk.",
                        "Type": "A",
                        "TTL": "120",
                        "ResourceRecords": [ "127.0.0.1" ]
                    },
                    {
                        "Name": "wooldrige.co.uk.",
                        "Type": "MX",
                        "TTL": "86400",
                        "ResourceRecords": [
                            "10 ASPMX.L.GOOGLE.COM.",
                            "20 ALT1.ASPMX.L.GOOGLE.COM.",
                            "20 ALT2.ASPMX.L.GOOGLE.COM.",
                            "30 ASPMX2.GOOGLEMAIL.COM.",
                            "30 ASPMX3.GOOGLEMAIL.COM.",
                            "30 ASPMX4.GOOGLEMAIL.COM.",
                            "30 ASPMX5.GOOGLEMAIL.COM."
                        ]
                    },
                    {
                        "Name": "google._domainkey.wooldrige.co.uk.",
                        "Type": "TXT",
                        "TTL": "86400",
                        "ResourceRecords": [ "\"v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDEgZWLAgAXgZZIkAC4Na4xU3UmFkuIvj3a4AHW3K45vN3BeiBQ5mYC5g/KcrXZhDsaWzp9qgi9chtT3CV/E4ZA8SDeJxmyVCu8PWxXBTc9akFah3lp3mgtLZY+sMrfGlMTdHFzJ1I7FlttFeCAMUXm2ZsQyoXqaIS9Ojjy1ddikQIDAQAB\"" ]
                    }
                ]
            }
        },
        "kempstonnurseriescoukDNS": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": "kempstonnurseries.co.uk.",
                "RecordSets": [
                    {
                        "Name": "kempstonnurseries.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "origin.kempstonnurseries.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.kempstonnurseries.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.origin.kempstonnurseries.co.uk.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "ZQJYDD6YQE2G.kempstonnurseries.co.uk.",
                        "Type": "CNAME",
                        "TTL": "1209600",
                        "ResourceRecords": [ "gv-KHYQWCRKN2VBQN.dv.googlehosted.com." ]
                    }
                ]
            }
        },
        "brignellbookbindersDNS": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneName": "brignellbookbinders.com.",
                "RecordSets": [
                    {
                        "Name": "brignellbookbinders.com.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "origin.brignellbookbinders.com.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.brignellbookbinders.com.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "www.origin.brignellbookbinders.com.",
                        "Type": "A",
                        "TTL": "3600",
                        "ResourceRecords": [{ "Ref": "SCBSEIP" }]
                    },
                    {
                        "Name": "mail.brignellbookbinders.com.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    },
                    {
                        "Name": "docs.brignellbookbinders.com.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    },
                    {
                        "Name": "calendar.brignellbookbinders.com.",
                        "Type": "CNAME",
                        "TTL": "86400",
                        "ResourceRecords": [ "ghs.google.com" ]
                    },
                    {
                        "Name": "brignellbookbinders.com.",
                        "Type": "MX",
                        "TTL": "86400",
                        "ResourceRecords": [
                            "10 ASPMX.L.GOOGLE.COM.",
                            "20 ALT1.ASPMX.L.GOOGLE.COM.",
                            "20 ALT2.ASPMX.L.GOOGLE.COM.",
                            "30 ASPMX2.GOOGLEMAIL.COM.",
                            "30 ASPMX3.GOOGLEMAIL.COM.",
                            "30 ASPMX4.GOOGLEMAIL.COM.",
                            "30 ASPMX5.GOOGLEMAIL.COM."
                        ]
                    }
                ]
            }
        },
        "SCBSEIP":{
           "Type": "AWS::EC2::EIP",
           "Properties": { }
        },
        "SCBSAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AvailabilityZones": [ "eu-west-1c" ],
                "LaunchConfigurationName": { "Ref": "SCBSLaunchConfiguration" },
                "MaxSize": "2",
                "MinSize": "1",
                "DesiredCapacity": "1"
             },
            "UpdatePolicy" : {
                "AutoScalingRollingUpdate" : {
                    "MaxBatchSize": "1",
                    "MinInstancesInService": "1",
                    "PauseTime": "PT0S"
                }
            }
        },
        "SCBSLaunchConfiguration": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": { "Ref": "AMI" },
                "InstanceType": "t1.micro",
                "IamInstanceProfile": { "Ref": "SCBSIamInstanceProfile" },
                "SecurityGroups": [{
                    "Ref": "SCBSSecurityGroup"
                }],
                "InstanceMonitoring": false,
                "UserData": {
                    "Fn::Base64" : {
                        "Fn::Join" : [ "", [ { "Ref" : "SCBSEIP" } ] ]
                    }
                }
            }
        },
        "SCBSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Only allow HTTP and SSH",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "SCBSAllocateEIPRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "ec2.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "Path": "/",
                "Policies": [{
                    "PolicyName": "OnlyAllowEIPAllocations",
                    "PolicyDocument": {
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": ["ec2:AssociateAddress"],
                            "Resource": ["*"]
                        }]
                    }
                }]
            }
        },
        "SCBSIamInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [{ "Ref": "SCBSAllocateEIPRole" }]
            }
        },
        "IAMUserRaspberryPi": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "Groups": [
                    { "Ref": "IAMGroupDynamicDNS" }
                ]
            }
        },
        "IAMGroupDynamicDNS": {
            "Type": "AWS::IAM::Group",
            "Properties": {
                "Policies": [ {
                    "PolicyName" : "onlyallowtoupdatewooldrigecouk",
                    "PolicyDocument": {
                        "Statement" : [
                            {
                                "Effect":"Allow",
                                "Action":[
                                    "route53:ChangeResourceRecordSets",
                                    "route53:GetChange",
                                    "route53:ListResourceRecordSets",
                                    "route53:GetHostedZone"
                                ],
                                "Resource":"arn:aws:route53:::hostedzone/Z1VIBQX07I3Y3K"
                            },
                            {
                                "Effect":"Allow",
                                "Action":[ "route53:GetChange" ],
                                "Resource":"arn:aws:route53:::change/*"
                            }
                        ]
                    }
                } ]
            }
        },
        "onmyplatecoukCloudFrontCDN": {
            "Type": "AWS::CloudFront::Distribution",
            "Properties": {
                "DistributionConfig": {
                    "Aliases": [ "www.onmyplate.co.uk" ],
                    "Origins": [
                        {
                            "DomainName": "www.origin.onmyplate.co.uk",
                            "Id": "www.origin.onmyplate.co.uk",
                            "CustomOriginConfig": {
                                "OriginProtocolPolicy": "http-only"
                            }
                        }
                    ],
                    "DefaultCacheBehavior": {
                        "TargetOriginId": "www.origin.onmyplate.co.uk",
                        "ForwardedValues": {
                            "QueryString": false
                        },
                        "ViewerProtocolPolicy": "allow-all",
                        "MinTTL": "86400"
                    },
                    "Enabled": "true"
                }
            }
        }
    }
}
