#!/usr/bin/env bash
#########################################################################
##   This file is controlled by Puppet - changes will be overwritten   ##
#########################################################################
set -eu

if ps waux | grep '[ssh] -D 8123'; then
    echo "SOCKS proxy already running..."
    ss -l | grep '8123'
else
    echo "Starting SOCKS proxy to pi3 on 127.0.0.1:8123"
    if ssh -D 8123 -f -C -N -y pi3; then
        echo "Proxy started"
    else
        echo 'ERROR: non-zero exit code from ssh(1)'
        sleep 10
    fi
fi

# This is mainly because of the start-socks.desktop entry
echo "Exciting script in 5 seconds"
sleep 5
