#########################################################################
##   This file is controlled by Puppet - changes will be overwritten   ##
#########################################################################

#This is a Nanoc::Site VHost
server {
    listen <%= http_port %>;
    server_name <%= domain %> origin.<%= domain %> <%= domain %>.preview.woolie.co.uk;

    root /var/nanoc/content/<%= domain %>;
    index index.html;

    #We should be service one resource per URL
    #TODO: Add redirect for the root resource with a trailing slash
    if ($request_uri ~ ^(.*/)index.html$) {
        return 301 $1;
    }

    # Far future Cache-Control for all assets
    location ~ ^/assets/ {
        expires 1y;
    }

    location ~ ^/favicon.ico$ {
        expires 1w;
    }

    access_log /var/log/nginx/<%= domain %>.access.log;
    error_log /var/log/nginx/<%= domain %>.error.log;

    include /var/nanoc/nginx-config/<%= domain %>/*.conf;
}

# www.domain.eg to domain.eg redirect
server {
    server_name www.<%= domain %> www.origin.<%= domain %>;
    rewrite ^(.*) http://<%= domain %>$1 permanent;
    expires 1M;

    access_log /var/log/nginx/www.<%= domain %>.access.log;
    error_log /var/log/nginx/www.<%= domain %>.error.log;
}

# static.domain.eg to domain.eg redirect
server {
    server_name static.<%= domain %> static.origin.<%= domain %>;
    rewrite ^(.*) http://<%= domain %>/static$1 permanent;
    expires 1M;

    access_log /var/log/nginx/static.<%= domain %>.access.log;
    error_log /var/log/nginx/static.<%= domain %>.error.log;
}
