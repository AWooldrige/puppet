#!/usr/bin/env python
from subprocess import check_output, CalledProcessError, STDOUT
import argparse
import os
from woolielibs.loghelper import bootstrap_logger
from logging import getLogger

LOGGER_NAME = "Nanoc_Site_Downloader"
REPO_PATH = "/var/nanoc/repos"


def scall(cmd):
    l = getLogger(LOGGER_NAME)
    l.debug("running command: " + cmd)
    try:
        stdout = check_output(cmd, stderr=STDOUT, shell=True)
    except CalledProcessError, e:
        l.error(e.output)
        raise e
    if stdout:
        l.debug(" |- output: " + stdout)


def git_head_commit(repo):
    hash_file = repo + "/.git/refs/heads/master"
    with open(hash_file) as f:
        return f.read()


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("domain", help="domain for the site")
    parser.add_argument("repo", help="git repo where the "
        "nanoc-site-downloader will download and install from")
    args = parser.parse_args()
    l = bootstrap_logger(LOGGER_NAME)

    if not os.path.exists(REPO_PATH):
        scall("mkdir {0} && chmod 755 {0}".format(REPO_PATH))

    repo = "{0}/{1}".format(REPO_PATH, args.domain)

    if not os.path.exists(repo):
        scall("git clone {0} {1} --depth=1".format(args.repo, repo))
    else:
        before = git_head_commit(repo)
        scall("(cd {} && git pull)".format(repo))
        if before == git_head_commit(repo):
            l.debug("Git repo master branch head points to the same commit, "
                    "no need to rebuild site: {0}".format(before))
            raise SystemExit

    scall("nh install -p {0}".format(repo))
