#!/usr/bin/env python3
import math
import socket
import datetime
import time
import unittest

import pytz
import click
from gpiozero import Servo
from gpiozero.pins.pigpio import PiGPIOFactory



def send_metric(name, value):
    msg = f"boilerctl {name}={value} {int(datetime.datetime.utcnow().timestamp())}"
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.sendto(bytes(msg, "utf-8"), ("127.0.0.1", 8094))


def move(pos):
    pigpio_f = PiGPIOFactory()

    """
    Spec sheet[1] for the SF180M says:
        - full min: 0.5ms
        - middle  : 1.5ms
        - full max: 2.5ms

    [1] https://m.media-amazon.com/images/I/81+CuFyNFcL.pdf
    """
    servo = Servo(
        12,  # GPIO 12 (header pin 32, hardware PWM 0)
        initial_value=None,  # Otherwise this blasts the servo to 'mid' as it defaults to 0
        min_pulse_width=0.5/1000,
        max_pulse_width=2.5/1000,
        pin_factory=pigpio_f  # Using pigpio to allow hardware PWM, removing jitter
    )

    send_metric('desired_servo_position', pos)
    servo.value = pos
    time.sleep(5)
    servo.detach()


def temp_to_servo_position(desired_temp_c, in_min=35, in_max=82, out_min=-1, out_max=1):
    """
    https://stackoverflow.com/a/43567380
    """
    assert desired_temp_c >= 35
    assert desired_temp_c <= 82
    return (desired_temp_c - in_min) * (out_max - out_min) / (in_max - in_min) + out_min


def move_dial_to_temp(desired_temp_c):
    send_metric('desired_temp_celcius', desired_temp_c)
    click.echo(f"Moving boiler dial to {desired_temp_c}C")
    move(temp_to_servo_position(desired_temp_c))


def in_low_temp_period_now():
    tz_lon = pytz.timezone('Europe/London')
    now = datetime.datetime.now(tz_lon)

    high_temp_periods = [
        ("03:30", "04:30"),
        ("08:00", "08:59"),
        ("14:00", "15:00")
    ]
    for start, end in high_temp_periods:
        start_h, start_m = start.split(':')
        end_h, end_m = start.split(':')

        start_t = datetime.time(int(start_h), int(start_m), tzinfo=tz_lon)
        end_t = datetime.time(int(end_h), int(end_m), tzinfo=tz_lon)

        if start_t <= now.time() <= end_t:
            click.echo(f"Current time of {now.time()} falls within high temp period between {start} and {end}")
            return False
    click.echo(f"Current time of {now.time()} falls within low temp period")
    return True


@click.group()
def cli():
    """
    TODO
    """


@click.command()
def calibrate():
    click.echo("Moving to min position. Turn boiler to min temperature, then attach servo horn in this position.")
    move(-1)


@cli.command()
def demo():
    move(-1)
    move(0)
    move(1)


@cli.command()
def autoset():
    if in_low_temp_period_now():
        send_metric('in_low_temp_period', 1)
        move_dial_to_temp(35)
    else:
        send_metric('in_low_temp_period', 0)
        move_dial_to_temp(65)


if __name__ == "__main__":
    # Dodgy version of unit testing within code :D
    assert temp_to_servo_position(35) == -1
    assert temp_to_servo_position(82) == 1
    assert temp_to_servo_position(58.5) == 0

    cli.add_command(calibrate)
    cli.add_command(autoset)
    cli.add_command(demo)
    cli()
